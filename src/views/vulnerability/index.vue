<template>
  <div class="app-container">
    <el-card class="box-card">
      <div slot="header" class="clearfix">
        <span class="card-title">
          <i class="el-icon-warning-outline"></i> 脆弱性分析
        </span>
        <div style="float: right">
          <el-button-group>
            <el-button
              type="primary"
              size="small"
              icon="el-icon-plus"
              @click="handleAdd">
              添加脆弱性
            </el-button>
            <el-button
              type="success"
              size="small"
              icon="el-icon-download"
              @click="handleExport">
              导出报告
            </el-button>
          </el-button-group>
        </div>
      </div>

      <!-- 搜索区域 -->
      <div class="search-container">
        <el-form :inline="true" :model="searchForm" size="small">
          <el-form-item label="资产名称">
            <el-select
              v-model="searchForm.assetId"
              filterable
              clearable
              placeholder="请选择资产">
              <el-option
                v-for="item in assetOptions"
                :key="item.id"
                :label="item.name"
                :value="item.id">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="handleSearch">查询</el-button>
            <el-button @click="resetSearch">重置</el-button>
          </el-form-item>
        </el-form>
      </div>

      <!-- 表格 -->
      <el-table
        v-loading="loading"
        :data="tableData"
        border
        stripe
        style="width: 100%">
        <el-table-column
          type="index"
          label="序号"
          width="80"
          align="center">
        </el-table-column>
        <el-table-column
          prop="assetName"
          label="资产名称"
          width="180">
          <template slot-scope="scope">
            <el-tag size="medium">{{ scope.row.assetName }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column
          prop="vulName"
          label="脆弱性名称"
          min-width="200">
        </el-table-column>
        <el-table-column
          prop="level"
          label="风险等级"
          width="100"
          align="center">
          <template slot-scope="scope">
            <el-tag :type="getLevelTag(scope.row.level)" size="medium">
              {{ scope.row.level }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column
          prop="status"
          label="状态"
          width="100"
          align="center">
          <template slot-scope="scope">
            <el-tag :type="getStatusTag(scope.row.status)" size="medium">
              {{ scope.row.status }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column
          label="操作"
          width="180"
          fixed="right"
          align="center">
          <template slot-scope="scope">
            <el-button-group>
              <el-button
                size="mini"
                type="primary"
                icon="el-icon-edit"
                @click="handleEdit(scope.row)">
                编辑
              </el-button>
              <el-button
                size="mini"
                type="danger"
                icon="el-icon-delete"
                @click="handleDelete(scope.row)">
                删除
              </el-button>
            </el-button-group>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <div class="pagination-container">
        <el-pagination
          background
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
          :current-page="currentPage"
          :page-sizes="[10, 20, 30, 50]"
          :page-size="pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="total">
        </el-pagination>
      </div>
    </el-card>

    <!-- 添加/编辑对话框 -->
    <el-dialog
      :title="dialogTitle"
      :visible.sync="dialogVisible"
      width="500px">
      <el-form
        :model="form"
        :rules="rules"
        ref="form"
        label-width="100px">
        <el-form-item label="资产名称" prop="assetId">
          <el-select
            v-model="form.assetId"
            filterable
            placeholder="请选择资产">
            <el-option
              v-for="item in assetOptions"
              :key="item.id"
              :label="item.name"
              :value="item.id">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="脆弱性名称" prop="vulName">
          <el-input v-model="form.vulName" placeholder="��输入脆弱性名称"></el-input>
        </el-form-item>
        <el-form-item label="风险等级" prop="level">
          <el-select v-model="form.level" placeholder="请选择风险等级">
            <el-option label="高" value="高"></el-option>
            <el-option label="中" value="中"></el-option>
            <el-option label="低" value="低"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="描述" prop="description">
          <el-input
            type="textarea"
            :rows="3"
            v-model="form.description"
            placeholder="请输入描述">
          </el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogVisible = false">取 消</el-button>
        <el-button type="primary" @click="submitForm">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import {selectAssets} from "@/api/asset";

export default {
  name: 'Vulnerability',
  data() {
    return {
      loading: false,
      searchForm: {
        assetId: ''
      },
      currentPage: 1,
      pageSize: 10,
      total: 0,
      dialogVisible: false,
      dialogTitle: '添加脆弱性',
      form: {
        assetId: '',
        vulName: '',
        level: '',
        description: ''
      },
      rules: {
        assetId: [
          { required: true, message: '请选择资产', trigger: 'change' }
        ],
        vulName: [
          { required: true, message: '请输入脆弱性名称', trigger: 'blur' }
        ],
        level: [
          { required: true, message: '请选择风险等级', trigger: 'change' }
        ]
      },
      // 从路由查询参数中获取 objectId
      objectId: null,
      assetOptions: [],
      tableData: []
    }
  },

  created() {
    // 从路由查询参数中获取 objectId
    const objectId = this.$cookie.get('objectId')
    if (!objectId) {
      this.$message.error('缺少评估对象ID参数')
      return
    }
    this.objectId = objectId
    this.getAssetList()
  },

  methods: {
    getLevelTag(level) {
      const types = {
        '高': 'danger',
        '中': 'warning',
        '低': 'success'
      }
      return types[level] || ''
    },
    getStatusTag(status) {
      const types = {
        '未修复': 'danger',
        '处理中': 'warning',
        '已修复': 'success'
      }
      return types[status] || ''
    },
    // 获取资产列表
    async getAssetList() {
      this.loading = true
      try {
        const res = await selectAssets(this.objectId)
        if (!res) {
          this.$message.error('获取资产列表失败')
          return
        }

        // 处理资产数据，保存完整的资产信息
        this.assetOptions = (res || []).map(item => {
          return {
            id: item.a_id,
            name: item.asset_name,
            risk_level: item.risk_level,
            threat_type: item.threat_type,
            description: item.asset_description,
            // 将脆弱性名称拆分为数组并生成完整的脆弱性对象
            vulnerabilities: item.vulnerability_name ?
              item.vulnerability_name.split('；').map((vul, index) => ({
                id: `${item.a_id}_${index}`,
                vulName: vul,
                assetId: item.a_id,
                assetName: item.asset_name,
                level: this.getRiskLevel(item.risk_level),
                status: '未修复',
                description: item.asset_description,
                threatType: item.threat_type
              })) : []
          }
        })

        // 如果有资产数据，默认选择第一个并生成脆弱性列表
        if (this.assetOptions.length > 0) {
          this.searchForm.assetId = this.assetOptions[0].id
          await this.handleSearch()
        }
      } catch (error) {
        console.error('获取资产列表失败:', error)
        this.$message.error('获取资产列表失败')
      } finally {
        this.loading = false
      }
    },

    // 修改搜索方法
    async handleSearch() {
      this.loading = true
      try {
        if (!this.searchForm.assetId) {
          // 如果没有选择资产，显示所有资产的脆弱性
          this.tableData = this.assetOptions.reduce((acc, asset) => {
            return acc.concat(asset.vulnerabilities)
          }, [])
        } else {
          // 找到选中的资产
          const selectedAsset = this.assetOptions.find(asset =>
            asset.id === this.searchForm.assetId
          )
          this.tableData = selectedAsset ? selectedAsset.vulnerabilities : []
        }
      } catch (error) {
        this.$message.error('获取脆弱性列表失败')
        console.error(error)
      } finally {
        this.loading = false
      }
    },

    // 修改重置搜索方法
    resetSearch() {
      this.searchForm.assetId = ''
      this.handleSearch() // 显示所有资产的脆弱性
    },
    handleSizeChange(val) {
      this.pageSize = val
      this.currentPage = 1
    },
    handleCurrentChange(val) {
      this.currentPage = val
    },
    handleAdd() {
      this.dialogTitle = '添加脆弱性'
      this.form = {
        assetId: '',
        vulName: '',
        level: '',
        description: ''
      }
      this.dialogVisible = true
    },
    handleEdit(row) {
      this.dialogTitle = '编辑脆弱性'
      this.form = { ...row }
      this.dialogVisible = true
    },
    handleDelete(row) {
      this.$confirm('确认删除该脆弱性记录?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        // 从对应资产的脆弱性列表中删除
        const asset = this.assetOptions.find(a => a.id === row.assetId)
        if (asset) {
          const index = asset.vulnerabilities.findIndex(v => v.id === row.id)
          if (index > -1) {
            asset.vulnerabilities.splice(index, 1)
            this.handleSearch() // 刷新表格
            this.$message.success('删除成功')
          }
        }
      }).catch(() => {})
    },
    // 修改表单提交方法
    async submitForm() {
      this.$refs.form.validate(async (valid) => {
        if (valid) {
          try {
            const data = {
              ...this.form,
              objectId: this.objectId
            }

            if (this.form.id) {
              await this.$http.put(`/api/vulnerabilities/${this.form.id}`, data)
            } else {
              await this.$http.post('/api/vulnerabilities', data)
            }

            this.dialogVisible = false
            this.$message.success('保存成功')
            this.handleSearch()
          } catch (error) {
            this.$message.error('保存失败')
            console.error(error)
          }
        }
      })
    },
    handleExport() {
      this.$message.success('报告导出成功')
    },
    // 添加获取风险等级的方法
    getRiskLevel(riskValue) {
      if (riskValue >= 80) return '高'
      if (riskValue >= 40) return '中'
      return '低'
    }
  }
}
</script>

<style scoped>
.app-container {
  padding: 20px;
}

.card-title {
  font-size: 16px;
  font-weight: bold;
}

.search-container {
  margin-bottom: 20px;
}

.pagination-container {
  margin-top: 20px;
  text-align: right;
}
</style>
